<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    #log {
      display: flex;
      height: auto;
    }

    #Instruction {
      flex: 1;
    }

    #V0F {
      flex: 1;
    }
  </style>
</head>

<body>
  <button id="choose">选择ROM</button>
  <button id="STOP">STOP</button>
  <button id="RUN">RUN</button>
  <button id="STEP">STEP</button>
  <div id="chip8_container"></div>
  <div id="log">
    <div id="Instruction"></div>
    <div id="V0F">
      <div>V0 <span id="V0"></span></div>
      <div>V1 <span id="V1"></span></div>
      <div>V2 <span id="V2"></span></div>
      <div>V3 <span id="V3"></span></div>
      <div>V4 <span id="V4"></span></div>
      <div>V5 <span id="V5"></span></div>
      <div>V6 <span id="V6"></span></div>
      <div>V7 <span id="V7"></span></div>
      <div>V8 <span id="V8"></span></div>
      <div>V9 <span id="V9"></span></div>
      <div>V10 <span id="V10"></span></div>
      <div>V11 <span id="V11"></span></div>
      <div>V12 <span id="V12"></span></div>
      <div>V13 <span id="V13"></span></div>
      <div>V14 <span id="V14"></span></div>
      <div>V15 <span id="V15"></span></div>
      <div>I <span id="I"></span></div>
      <div>PC <span id="PC"></span></div>
    </div>
  </div>
  <script type="module">
    import Chip8 from './chip8.js'

    let chip8 = Object.create(Chip8);
    chip8.init({
      container: "#chip8_container",
    });

    document.onkeydown = (e) => {
      let key = e.key;
      for (let _0xKey in KeyboardMap) {
        if (KeyboardMap[_0xKey] == key) {
          chip8.keyDown(parseInt(_0xKey, 16));
        }
      }
    }
    document.onkeyup = (e) => {
      let key = e.key;
      for (let _0xKey in KeyboardMap) {
        if (KeyboardMap[_0xKey] == key) {
          chip8.keyUp(parseInt(_0xKey, 16));
        }
      }
    }

    let $selectButton = document.querySelector("#choose");
    $selectButton.addEventListener("click", function () {
      chooseFile((buffer) => {
        chip8.read(buffer);
      });
    });

    let $runButton = document.querySelector("#RUN");
    $runButton.addEventListener("click", function () {
      chip8.run();
    });

    let $stopButton = document.querySelector("#STOP");
    $stopButton.addEventListener("click", function () {
      chip8.stop();
    });

    let $stepButton = document.querySelector("#STEP");
    $stepButton.addEventListener("click", function () {
      chip8.step();
      updateStatus();
    });


    function chooseFile(callback) {
      let $input = document.createElement("input");
      $input.setAttribute("type", "file");
      $input.setAttribute("style", "visibility:hidden");
      document.body.appendChild($input);
      $input.addEventListener("change", (e) => {
        let files = e.target.files;
        const reader = new FileReader();
        reader.readAsArrayBuffer(files[0]);
        reader.onload = () => {
          const buffer = new Uint8Array(reader.result);
          callback && callback(buffer);
        }
      });
      $input.click();
    }

    function updateStatus() {
      let {
        V_Array,
        Register_I,
        Program_Counter
      } = chip8.getRegister();
      V_Array.forEach((val, index) => {
        let $span = document.querySelector("#V" + index);
        $span.innerHTML = val;
      })
      let $spanI = document.querySelector("#I");
      $spanI.innerHTML = Register_I;
      let $spanPC = document.querySelector("#PC");
      $spanPC.innerHTML = Program_Counter;
    }


    const KeyboardMap = {
      "0": "x",
      "1": "1",
      "2": "2",
      "3": "3",
      "4": "q",
      "5": "w",
      "6": "e",
      "7": "a",
      "8": "s",
      "9": "d",
      "A": "z",
      "B": "c",
      "C": "4",
      "D": "r",
      "E": "f",
      "F": "v",
    };
  </script>
</body>

</html>